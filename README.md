# Introduction

A deep learning based tool to automatically select the best reconstructed 3D maps within a group of maps.

## Installation

<details>

Clone the repository:

```bash
git clone github.itap.purdue.edu/kiharalab/AutoClass3D
```

Create pixi environment (recommended):

Install pixi:

```bash
curl -fsSL https://pixi.sh/install.sh | bash
```

Install environment:

```bash
pixi install
```

</details>

# AutoClass3D

## AutoSelect3D Standalone Usage without RELION:

```bash
pixi run cryoread
```

<details>

### Arguments for Class3D/InitialModel Selection

### Arguments

Required Arguments:
* `-f, --files`: List of input mrc files. Accepts multiple files separated by spaces. These are the MRC files that will be processed and selected.

* `-o, --output`: Output folder name. Directory where all output files will be stored.

* `-g, --gpus`: GPU ID to use for CryoREAD prediction. Specifies which GPU device should be used for processing. Multiple GPU IDs can be provided using a comma-separated list.

Optional Arguments:
* `--temp`: Temporary directory path for intermediate files (default: "/tmp")

* `--debug`: Enable debug mode to generate full output (default: False). When enabled, copy the full cryoREAD output to the output directory for debugging.

* `-r, --reso`: Resolution setting to choose the deep learning model (default: "Low"). Determines which model checkpoint will be used based on the desired resolution.

* `-b, --batch`: Batch size to use for CryoREAD prediction. Controls how many boxes are processed simultaneously during the prediction phase.

* `--dryrun`: When enabled, performs a dry run that only prints commands without actually executing CryoREAD. Useful for testing and verification.


### Example for Class3D/InitialModel Selection

```bash
pixi run cryoread -f Class3D/job052/class1.mrc Class3D/job052/class2.mrc Class3D/job052/class3.mrc -g 0,1,2 -o job052_select --temp ./temp
```

</details>

## AutoSelect3D Usage with RELION GUI Integration:

<details>

### There are three files associated with RELION integration of AutoSelect3D:

- `gtf_relion4_run_select_class3d.py` <- **this is the main file to execute**
- `gtf_relion4_create_select3d_data_star.py`
- `gtf_relion4_select3d.py`

### Arguments

Required Arguments:
* `-i, --input, --in_parts`: Input particle star file path (relative). This star file should come from RELION InitialModel/Class3D run and is automatically generated by RELION.

* `-o, --output`: Output job directory path (relative). This directory is automatically generated by RELION and will store all output files.

* `-g, --gpus`: GPU ID to use for CryoREAD prediction. Specifies which GPU device should be used for processing. Multiple GPU IDs can be provided using a comma-separated list.

Optional Arguments:
* `--temp`: Temporary directory path for intermediate files (default: "/tmp")

* `--debug`: Enable debug mode to generate full output (default: False). When enabled, copy the full cryoREAD output to the output directory for debugging.

* `-r, --reso`: Resolution setting to choose the deep learning model (default: "Low"). Determines which model checkpoint will be used based on the desired resolution.

* `-b, --batch`: Batch size to use for CryoREAD prediction. Controls how many boxes are processed simultaneously during the prediction phase.

### Example with RELION GUI


1. From RELION GUI, Choose "External", then in "External Executable" box enter `python /path/to/gtf_relion4_run_select_class3d.py`.
2. In the "Input" tab, in "Input Particles" box, enter the path to the input data star file like `Class3D/job052/run_it200_data.star`.
3. In the Params tab, enter `gpus` in values box, then enter the gpus to use for inference like `0,1,2`. (required)
4. In the Params tab, enter other optional parameters like `temp` (optional), `debug` (optional), `reso` (optional), `batch` (optional), and their corresponding values.
5. In the Running tab, the "Number of threads" box should be set to 1.
6. Adjust your submission to queue setting accordingly if you use a managed queue job submission system.
7. Click the "Run" button.
8. Once the job is finished, the results will be stored in the output job directory created by RELION.

</details>

## List of Output Files:

<details>

| File                                                                                                                                    | Description                                                                                                                                      |
|-----------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| {map_name}_CCC_FSC05.txt                                                                                                                | The first line is Real space CCC between CryoREAD prediction probabilities and input map, the second line is FSC 0.5 cutoff between the two maps |
| {map_name}_chain_base_prob.mrc, {map_name}_chain_phosphate_prob.mrc, {map_name}_chain_sugar_prob.mrc, {map_name}_chain_protein_prob.mrc | The predicted probabilities for nitrogenous bases, phosphate backbone, sugar ring, and protein                                                   |
| selected_model_map.mrc                                                                                                                  | The selected map based on maximum CCC criteria                                                                                                   |
| {map_name}_mask_protein.mrc                                                                                                             | The generated protein mask based on a custom cutoff value on protein probability                                                                 |
| {map_name}_segment.mrc                                                                                                                  | The resampled and cropped map used as input for CryoREAD                                                                                         |

</details>

# AutoContour

## Arguments for Auto Contouring

```

-i: Input MRC map file to determine the contour
-o: Output folder to store all the files
-p: Plot all components (Optional, False by default)
-n: Number of intializations (Optional, 3 by default)

```

## Example for GMM Auto Contouring for Rough Masking

```bash
python contour.py -i ./Class3D/job052/class1.mrc -o ./output_folder -p
```

## Example for CryoREAD Auto Refinement Masking

```bash
python contour.py -i ./Class3D/job052/class1.mrc -o ./output_folder -p -r
```